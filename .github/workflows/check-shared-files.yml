name: Check shared files and version sync

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'skills/**/references/version-check.md'
      - 'skills/**/references/dossier-template.md'
      - 'skills/**/references/content-audit.md'
      - 'skills/**/references/customer-profile.md'
      - 'skills/**/migrations/**'
      - 'skills/**/SKILL.md'
      - '.claude-plugin/plugin.json'
      - 'skills/**/references/prompt-site-agent.md'
      - '.github/**'

jobs:
  check-plugin-version:
    name: Plugin version must not already be tagged
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version tag does not exist
        run: |
          version=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          echo "Plugin version: $version"
          if git tag -l "v${version}" | grep -q .; then
            echo "::error::Tag v${version} already exists. Update the version in .claude-plugin/plugin.json before proceeding."
            exit 1
          fi
          echo "Tag v${version} does not exist yet."

  check-version-check-sync:
    name: version-check.md files must be identical
    needs: check-plugin-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version-check.md files are identical
        run: |
          files=$(find skills -name "version-check.md" -path "*/references/*" | sort)
          count=$(echo "$files" | wc -l)

          if [ "$count" -lt 2 ]; then
            echo "Only $count version-check.md file found â€” nothing to compare."
            exit 0
          fi

          first=$(echo "$files" | head -1)
          all_match=true

          while IFS= read -r file; do
            if [ "$file" = "$first" ]; then
              continue
            fi
            if ! diff -q "$first" "$file" > /dev/null 2>&1; then
              echo "::error::Files differ: $first vs $file"
              diff --unified "$first" "$file" || true
              all_match=false
            fi
          done <<< "$files"

          if [ "$all_match" = false ]; then
            echo ""
            echo "All version-check.md files across skills must be identical."
            echo "Update all copies to match, then push again."
            exit 1
          fi

          echo "All version-check.md files are identical."

  check-template-version-stamps:
    name: Output templates must contain skill_version frontmatter
    needs: check-plugin-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check output templates for skill_version
        run: |
          all_ok=true

          templates=(
            "skills/market-research/references/dossier-template.md"
            "skills/prospect-psychology-audit/references/content-audit.md"
            "skills/prospect-psychology-audit/references/customer-profile.md"
          )

          for template in "${templates[@]}"; do
            if [ ! -f "$template" ]; then
              echo "::error::Template file not found: $template"
              all_ok=false
              continue
            fi

            if ! grep -q "skill_version" "$template"; then
              echo "::error::Missing skill_version in frontmatter: $template"
              all_ok=false
            else
              echo "$template: contains skill_version (ok)"
            fi
          done

          if [ "$all_ok" = false ]; then
            echo ""
            echo "All output templates must include skill_version in their YAML frontmatter."
            echo "This ensures artifacts can be version-detected for future migrations."
            exit 1
          fi

          echo "All output templates contain skill_version."

  check-version-sync:
    name: SKILL.md versions must match plugin.json
    needs: check-plugin-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version fields are in sync
        run: |
          plugin_version=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          echo "plugin.json version: $plugin_version"

          all_match=true

          for skill_file in skills/*/SKILL.md; do
            skill_version=$(sed -n '/^---$/,/^---$/p' "$skill_file" | grep -A1 '^metadata:' | grep 'version:' | head -1 | sed 's/.*version:[[:space:]]*//')
            skill_name=$(basename "$(dirname "$skill_file")")

            if [ -z "$skill_version" ]; then
              echo "::error::$skill_file is missing a version field in its frontmatter"
              all_match=false
            elif [ "$skill_version" != "$plugin_version" ]; then
              echo "::error::Version mismatch: $skill_file has $skill_version but plugin.json has $plugin_version"
              all_match=false
            else
              echo "$skill_name: $skill_version (matches)"
            fi
          done

          if [ "$all_match" = false ]; then
            echo ""
            echo "Every SKILL.md version must match the version in .claude-plugin/plugin.json."
            echo "Update all version fields to match, then push again."
            exit 1
          fi

          echo "All versions are in sync."

  discover-skills:
    name: Discover skills
    needs:
      - check-version-check-sync
      - check-template-version-stamps
      - check-version-sync
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.discover.outputs.skills }}
      version: ${{ steps.discover.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Discover skill names and version
        id: discover
        run: |
          version=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          skills=$(ls -d skills/*/ | xargs -n1 basename | python3 -c "import sys,json; print(json.dumps(sys.stdin.read().split()))")
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "skills=$skills" >> "$GITHUB_OUTPUT"
          echo "Version: $version"
          echo "Skills: $skills"

  package-skill:
    name: Package ${{ matrix.skill }}
    needs: discover-skills
    runs-on: ubuntu-latest
    strategy:
      matrix:
        skill: ${{ fromJson(needs.discover-skills.outputs.skills) }}
    steps:
      - uses: actions/checkout@v4

      - name: Upload ${{ matrix.skill }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.skill }}
          path: skills/${{ matrix.skill }}/

  create-release:
    name: Create release
    needs: package-skill
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          version=$(python3 -c "import json; print(json.load(open('.claude-plugin/plugin.json'))['version'])")
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Version: $version"

      - name: Check release does not already exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" > /dev/null 2>&1; then
            echo "::error::Release v${{ steps.version.outputs.version }} already exists. Update the version in .claude-plugin/plugin.json before pushing."
            exit 1
          fi

      - name: Download all skill artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Zip skill artifacts
        run: |
          mkdir -p release-assets
          for dir in artifacts/*/; do
            skill_name=$(basename "$dir")
            echo "Zipping $skill_name"
            (cd "$dir" && zip -r "../../release-assets/${skill_name}.zip" .)
          done
          echo "Release assets:"
          ls -lh release-assets/

      - name: Generate release notes
        id: notes
        run: |
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$last_tag" ]; then
            log=$(git log "${last_tag}..HEAD" --oneline)
          else
            log=$(git log --oneline)
          fi
          {
            echo "notes<<EOF"
            echo "$log"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ steps.version.outputs.version }}"
          gh release create "v${version}" \
            --title "Release ${version}" \
            --notes "${{ steps.notes.outputs.notes }}" \
            release-assets/*.zip
